<!DOCTYPE html>
<html lang="fr" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Coder ses dashboards Grafana avec Grafonnet - Benoit Petit</title>
  <meta name="description" content="On ne présente plus Grafana en ce qui concerne la visualisation de graphiques et de données. Cet outil est très largement utilisé pour des besoins de monitoring, de métrologie&hellip;
Les avantages sont multiples:
 open-source pratique : on peut créer des dashboards pour divers besoin très simplement flexible : de nombreuses sources de données sont supportées et les plugins répondent aux besoins les plus exotiques  Grafana permet également de déclencher des alertes lorsqu&rsquo;une métrique dépasse une certaine valeur (plus besoin de configurer un système d&rsquo;alerte propre à chaque source de donnée).">
  <meta name="author" content="Benoit Petit"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "Benoit Petit",
    
    "url": "https:\/\/bpetit.nce.re"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/bpetit.nce.re"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/bpetit.nce.re",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/bpetit.nce.re\/fr\/2021\/03\/coder-ses-dashboards-grafana-avec-grafonnet\/",
          "name": "Coder ses dashboards grafana avec grafonnet"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "Benoit Petit"
  },
  "headline": "Coder ses dashboards Grafana avec Grafonnet",
  "description" : "On ne présente plus Grafana en ce qui concerne la visualisation de graphiques et de données. Cet outil est très largement utilisé pour des besoins de monitoring, de métrologie\u0026hellip;\nLes avantages sont multiples:\n open-source pratique : on peut créer des dashboards pour divers besoin très simplement flexible : de nombreuses sources de données sont supportées et les plugins répondent aux besoins les plus exotiques  Grafana permet également de déclencher des alertes lorsqu\u0026rsquo;une métrique dépasse une certaine valeur (plus besoin de configurer un système d\u0026rsquo;alerte propre à chaque source de donnée).",
  "inLanguage" : "fr",
  "wordCount":  1166 ,
  "datePublished" : "2021-03-22T15:40:24",
  "dateModified" : "2021-03-22T15:40:24",
  "image" : "https:\/\/bpetit.nce.re",
  "keywords" : [ "monitoring, grafana, sre, automatisation, open-source, devops, tech" ],
  "mainEntityOfPage" : "https:\/\/bpetit.nce.re\/fr\/2021\/03\/coder-ses-dashboards-grafana-avec-grafonnet\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/bpetit.nce.re",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/bpetit.nce.re",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>

<meta property="og:title" content="Coder ses dashboards Grafana avec Grafonnet" />
<meta property="og:description" content="On ne présente plus Grafana en ce qui concerne la visualisation de graphiques et de données. Cet outil est très largement utilisé pour des besoins de monitoring, de métrologie&hellip;
Les avantages sont multiples:
 open-source pratique : on peut créer des dashboards pour divers besoin très simplement flexible : de nombreuses sources de données sont supportées et les plugins répondent aux besoins les plus exotiques  Grafana permet également de déclencher des alertes lorsqu&rsquo;une métrique dépasse une certaine valeur (plus besoin de configurer un système d&rsquo;alerte propre à chaque source de donnée).">
<meta property="og:image" content="https://bpetit.nce.re/grafonnet.png" />
<meta property="og:url" content="https://bpetit.nce.re/fr/2021/03/coder-ses-dashboards-grafana-avec-grafonnet/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="Benoit Petit" />

  <meta name="twitter:title" content="Coder ses dashboards Grafana avec Grafonnet" />
  <meta name="twitter:description" content="On ne présente plus Grafana en ce qui concerne la visualisation de graphiques et de données. Cet outil est très largement utilisé pour des besoins de monitoring, de métrologie&hellip;
Les avantages …">
  <meta name="twitter:image" content="https://bpetit.nce.re/grafonnet.png" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@bpetit_" />
  <meta name="twitter:creator" content="@bpetit_" />
  <meta name="generator" content="Hugo 0.82.0" />
  <link rel="alternate" href="https://bpetit.nce.re/fr/index.xml" type="application/rss+xml" title="Benoit Petit"><link rel="stylesheet" href="https://bpetit.nce.re/css/katex.min.css" />
  <link rel="stylesheet" href="https://bpetit.nce.re/fontawesome/css/all.css" />
  <link rel="stylesheet" href="https://bpetit.nce.re/css/bootstrap.min.css" /><link rel="stylesheet" href="https://bpetit.nce.re/css/main.css" /><link rel="stylesheet" href="https://bpetit.nce.re/css/fonts.css" /><link rel="stylesheet" href="https://bpetit.nce.re/css/syntax.css" /><link rel="stylesheet" href="https://bpetit.nce.re/css/codeblock.css" /><link rel="stylesheet" href="https://bpetit.nce.re/css/photoswipe.min.css" />
  <link rel="stylesheet" href="https://bpetit.nce.re/css/photoswipe.default-skin.min.css" />



  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://bpetit.nce.re/fr/">Benoit Petit</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        

        
          
            <li>
              
                
                  <a href="/en" lang="en">English</a>
                
              
                
              
            </li>
          
        

        
      </ul>
    </div>

    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="posts-heading">
              
                <h1>Coder ses dashboards Grafana avec Grafonnet</h1>
              
              
                <hr class="small">
              
              
              
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <p>On ne présente plus <a href="https://grafana.com/">Grafana</a> en ce qui concerne la visualisation de graphiques et de données. Cet outil est très largement utilisé pour des besoins de monitoring, de métrologie&hellip;</p>
<p>Les avantages sont multiples:</p>
<ul>
<li>open-source</li>
<li>pratique : on peut créer des dashboards pour divers besoin très simplement</li>
<li>flexible : de nombreuses sources de données sont supportées et les plugins répondent aux besoins les plus exotiques</li>
</ul>
<p>Grafana permet également de déclencher des alertes lorsqu&rsquo;une métrique dépasse une certaine valeur (plus besoin de configurer un système d&rsquo;alerte propre à chaque source de donnée). C&rsquo;est devenu un incontournable (en tout cas pour moi).</p>
<p>On peut également partager ses dashboards sous forme de fichiers JSON, ce qui est très pratique. Mais c&rsquo;est là que certaines frictions peuvent apparaître : éditer du JSON à la main avec des IDs barbare et des options étranges, ce n&rsquo;est pas fait pour un humain !</p>
<p>De plus si l&rsquo;on souhaite générer des variantes de dashboards à la volée, manipuler du JSON directement, c&rsquo;est un peu limité.</p>
<p>Si vous faîtes le même constat que moi je vous encourage vivement à regarder de plus près: <a href="https://grafana.github.io/grafonnet-lib/">grafonnet</a>.</p>
<p>Il s&rsquo;agit d&rsquo;une bibliothèque pour <a href="https://github.com/google/jsonnet">Jsonnet</a> qui est ni plus ni moins qu&rsquo;un langage de templating (ou modèle/gabarit/patron en bon français). C&rsquo;est un langage qui va nous permettre de créer des modèles de dashboards, d&rsquo;en faire des variantes et de les éditer <strong>à partir du code</strong>.</p>
<h2 id="installation">Installation</h2>
<p>Petite précision : je vais ici présenter <a href="https://github.com/google/go-jsonnet">go-jsonnet</a>, qui est une implémentation plus récente que le projet jsonnet original et réputée plus performante (je n&rsquo;ai pas comparé). Si vous avez déjà joué avec des projets écrits en Go cette commande vous sera familière :</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go get github.com/google/go-jsonnet/cmd/jsonnet</code></pre></div>
<p>Assurez vous alors que votre path Go est bien compris dans <code>$PATH</code> et vous pourrez lancer :</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">jsonnet --help
	Jsonnet commandline interpreter (Go implementation) v0<span style="color:#3677a9">.17.0</span>

jsonnet {&lt;option&gt;} &lt;filename&gt;

Available options:
  -h / --help                This message
  -e / --exec                Treat filename as code
  -J / --jpath &lt;dir&gt;         Specify an additional library search dir
[...]
</code></pre></div>
<p>Nous allons également avoir besoin de Grafonnet, que nous allons placer dans le dossier courant :</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">git clone https:<span style="color:#999;font-style:italic">//github.com/grafana/grafonnet-lib.git
</span></code></pre></div>
<p>Passons maitenant au code.</p>
<h2 id="premier-dashboard">Premier dashboard</h2>
<p>Posons les bases de notre premier dashboard :</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">local grafana = <span style="color:#6ab825;font-weight:bold">import</span> <span style="color:#ed9d13">&#39;grafonnet/grafana.libsonnet&#39;</span>;
local dashboard = grafana.dashboard;
local template = grafana.template;

dashboard.<span style="color:#6ab825;font-weight:bold">new</span>(
    <span style="color:#ed9d13">&#39;Scaphandre example dashboard&#39;</span>,
    tags=[<span style="color:#ed9d13">&#39;scaphandre&#39;</span>, <span style="color:#ed9d13">&#39;energy&#39;</span>, <span style="color:#ed9d13">&#39;power&#39;</span>],
    editable=<span style="color:#6ab825;font-weight:bold">true</span>
)
.addTemplate(
    template.datasource(
        <span style="color:#ed9d13">&#39;PROMETHEUS_DS&#39;</span>,
        <span style="color:#ed9d13">&#39;prometheus&#39;</span>,
        <span style="color:#ed9d13">&#39;Prometheus&#39;</span>,
        hide=<span style="color:#ed9d13">&#39;label&#39;</span>,
    )
)
</code></pre></div>
<p>Ici on déclare trois variables :</p>
<ul>
<li><code>grafana</code> qui va comprendre le chemin vers notre bibliothèque grafonnet (nous verrons ensuite comment appeller effectivement la bibliothèque)</li>
<li><code>dashboard</code> et <code>template</code> qui vous nous permettre de manipuler respectivement un <a href="https://grafana.com/docs/grafana/latest/dashboards/">dashboard</a> et des <a href="https://grafana.com/docs/grafana/latest/variables/">templates</a> sans avoir à repréciser le préfixe <code>grafana.</code> à chaque fois</li>
</ul>
<p>Puis on appelle la fonction <a href="https://grafana.github.io/grafonnet-lib/api-docs/#dashboardnew">new</a> pour créer un nouveau dashboard, on lui donne un nom, des tags pour l&rsquo;identifier facilement lorsque l&rsquo;on aura de nombreux dashboards sur notre instance grafana et on demande à ce qu&rsquo;il soit éditable (c&rsquo;est toujours pratique de pouvoir tester quelques options à la main).</p>
<p>On appelle ensuite la fonction <code>addTemplate</code> pour créer notre variable, qui sera un <a href="https://grafana.github.io/grafonnet-lib/api-docs/#templatedatasource">datasource</a> et nous permettra en un clic de sélectionner une source de donnée différente (ce qui est pratique si l&rsquo;on va chercher des données dans plusieurs instances prometheus différentes par exemple).</p>
<p>On sauvegarde ce fichier et on le nomme <code>dashboard.jsonnet</code>.</p>
<h2 id="utilisation">Utilisation</h2>
<p>Nous allons maintenant lancer jsonnet, lui dire d&rsquo;utiliser la biliothèque qui nous intéresse pour faire nos dashboards (Grafonnet) et lui donner notre template à digérer :</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">	jsonnet -J grafonnet-lib dashboard.jsonnet</code></pre></div>
<p>Par défaut jsonnet afficher le résultat sur la sortie standard, ce qui n&rsquo;est pas très pratique. On redirige le tout dans un fichier :</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">	jsonnet -J grafonnet-lib dashboard.jsonnet &gt; bidouille.json</code></pre></div>
<p>Une fois fait il n&rsquo;y a plus qu&rsquo;à importer le dashboard dans grafana et le tour est joué. A ce stade, on aura un dashboard vide avec notre variable en haut à gauche.</p>
<p>Dans mon cas, le conteneur grafana a un volume attaché qui permet de donner à grafana un répertoire de dashboards (fichiers json) par défaut, grafana <a href="https://github.com/hubblo-org/scaphandre/blob/main/docker-compose/grafana/dashboards.yml">étant configuré pour charger ce dashboard</a>. De cette manière je peux générer un dashboard en JSON puis redémarrer le conteneur grafana pour tester mes changements :</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">jsonnet -J ~/git/grafonnet-lib ../sample.jsonnet &gt; dashboards/sample-dashboard.json &amp;&amp; docker-compose restart grafana</code></pre></div>
<h2 id="remplir-le-dashboard">Remplir le dashboard</h2>
<p>Notre dashboard n&rsquo;est pas très intéressant, c&rsquo;était l&rsquo;exemple de base. Voyons comment l&rsquo;agrémenter et faire un dashboard pour remonter la consommation d&rsquo;énergie détaillée de mon laptop avec <a href="https://github.com/hubblo-org/scaphandre/">Scaphandre</a> et la stack <a href="https://github.com/hubblo-org/scaphandre/tree/main/docker-compose">docker-compose</a> qui va bien pour des tests en local.</p>
<p>Nous avons déjà vu les objet dashboard et template. Nous allons maintenant ajouter une ligne (row) à notre dashboard et insérer des graphes dans cette ligne. Pour ce faire, on appelle directement la fonction <a href="">addRow</a> sur l&rsquo;appel à la fonction <a href="">addTemplate</a> vue <a href="#premier-dashboard">précédemment</a>:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">[...]
.addRow(
    row.<span style="color:#6ab825;font-weight:bold">new</span>(
        title=<span style="color:#ed9d13">&#39;Per hosts&#39;</span>,
    )
    .addPanel(
        grafana.graphPanel.<span style="color:#6ab825;font-weight:bold">new</span>(
            title=<span style="color:#ed9d13">&#39;Hosts power consumption&#39;</span>,
            datasource=<span style="color:#ed9d13">&#39;${PROMETHEUS_DS}&#39;</span>,
            format=<span style="color:#ed9d13">&#39;W&#39;</span>,
            span=<span style="color:#3677a9">6</span>,
        )
        .addTarget(
            grafana.prometheus.target(
                <span style="color:#ed9d13">&#39;scaph_host_power_microwatts / 1000000&#39;</span>,
                legendFormat=<span style="color:#ed9d13">&#39;{{instance}}&#39;</span>,
            )
        )
    )
    .addPanel(
        grafana.graphPanel.<span style="color:#6ab825;font-weight:bold">new</span>(
            title=<span style="color:#ed9d13">&#39;Hosts power consumption total (dynamic time range)&#39;</span>,
            datasource=<span style="color:#ed9d13">&#39;${PROMETHEUS_DS}&#39;</span>,
            span=<span style="color:#3677a9">4</span>,
            bars=<span style="color:#6ab825;font-weight:bold">true</span>,
            format=<span style="color:#ed9d13">&#39;Wh&#39;</span>,
            x_axis_mode=<span style="color:#ed9d13">&#39;series&#39;</span>,
            min=<span style="color:#3677a9">0</span>
        )
        .addTarget(
            grafana.prometheus.target(
                <span style="color:#ed9d13">&#39;sum(avg_over_time(scaph_host_power_microwatts[1h]))/1000000&#39;</span>,
                legendFormat=<span style="color:#ed9d13">&#39;total of hosts, during displayed time window&#39;</span>,
                interval=<span style="color:#ed9d13">&#39;1h&#39;</span>
            )
        )
    )
)
</code></pre></div>
<p>Dans l&rsquo;appel à <code>addRow</code> on créé une nouvelle ligne avec <a href="https://grafana.github.io/grafonnet-lib/api-docs/#rownew">row.new</a>, on donne un titre à cette ligne (ici je cette ligne servira aux métriques de consommation de la machine), puis on appelle [addPanel](sur la ligne résultante).</p>
<p>On appelle alors <a href="https://grafana.github.io/grafonnet-lib/api-docs/#graphpanelnew">grafana.graphPanel.new</a> pour créer notre graphe de consommation de la machine, en précisant l&rsquo;unité (Watts), la source de données (l&rsquo;instance prometheus tel que nommé avec la variable définie plus haut) et la largeur du graphique.</p>
<p>On ajoute ensuite une requête au graphique avec <code>addTarget</code> et un objet <a href="https://grafana.github.io/grafonnet-lib/api-docs/#prometheustarget">prometheus.target</a> pour lequel on précise la requête PromQL, ici la consommation d&rsquo;énergie de la machine en microwatts que l&rsquo;on divise pour obtenir des watts, puis la légende.</p>
<p>On obtient donc :</p>
<p><img src="/grafonnet_sample_1.png" alt="Dashboard grafana"></p>
<p>Comme lorsque vous éditez vos panels à la main, on peut ajouter plusieurs requêtes/courbes dans le même panel en chaînant les appels <code>addTarget</code>. De même on peut ajouter des lignes en chaînant les appels <code>addRow</code>. Ajoutons une ligne pour la consommation par socket CPU et une autre pour la consommation des processus qui tournent sur la machine :</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">[...]
.addRow(
    row.<span style="color:#6ab825;font-weight:bold">new</span>(
        title=<span style="color:#ed9d13">&#39;Per CPU Sockets&#39;</span>
    )
    .addPanel(
        grafana.graphPanel.<span style="color:#6ab825;font-weight:bold">new</span>(
            title=<span style="color:#ed9d13">&#39;Socket power consumption&#39;</span>,
            datasource=<span style="color:#ed9d13">&#39;${PROMETHEUS_DS}&#39;</span>,
            format=<span style="color:#ed9d13">&#39;W&#39;</span>,
            span=<span style="color:#3677a9">6</span>,
        )
        .addTarget(
            grafana.prometheus.target(
                <span style="color:#ed9d13">&#39;scaph_socket_power_microwatts / 1000000&#39;</span>,
                legendFormat=<span style="color:#ed9d13">&#39;{{instance}} Socket {{socket_id}}&#39;</span>,
            )
        )
    )
)
.addRow(
    row.<span style="color:#6ab825;font-weight:bold">new</span>(
        title=<span style="color:#ed9d13">&#39;Per process&#39;</span>,
    )
    .addPanel(
        grafana.statPanel.<span style="color:#6ab825;font-weight:bold">new</span>(
            title=<span style="color:#ed9d13">&#39;Top process consumers&#39;</span>,
            datasource=<span style="color:#ed9d13">&#39;${PROMETHEUS_DS}&#39;</span>,
        )
        .addTarget(
            grafana.prometheus.target(
                <span style="color:#ed9d13">&#39;sort_desc(topk(3, sum by (exe) (scaph_process_power_consumption_microwatts/1000000)))&#39;</span>,
                legendFormat=<span style="color:#ed9d13">&#39;{{exe}}&#39;</span>,
            )
        )
    )
    .addPanel(
        grafana.graphPanel.<span style="color:#6ab825;font-weight:bold">new</span>(
            title=<span style="color:#ed9d13">&#39;Filtered process (process_filter) power, by exe&#39;</span>,
            datasource=<span style="color:#ed9d13">&#39;${PROMETHEUS_DS}&#39;</span>,
            span=<span style="color:#3677a9">8</span>,
            format=<span style="color:#ed9d13">&#39;W&#39;</span>,
            legend_rightSide=<span style="color:#6ab825;font-weight:bold">true</span>,
            legend_alignAsTable=<span style="color:#6ab825;font-weight:bold">true</span>,
            legend_sideWidth=<span style="color:#ed9d13">&#39;30%&#39;</span>,
            stack=<span style="color:#6ab825;font-weight:bold">true</span>
        )
        .addTarget(
            grafana.prometheus.target(
                <span style="color:#ed9d13">&#39;scaph_process_power_consumption_microwatts{exe=~&#34;.*${process_filter}.*&#34;}/1000000&#39;</span>,
                legendFormat=<span style="color:#ed9d13">&#39;{{ cmdline }}&#39;</span>,
            )
        )
    )
)
</code></pre></div>
<p>J&rsquo;ai également ajouté dans cet exemple une Target qui fait appel à une variable <code>process_filter</code>.  La variable permet à l&rsquo;utilisateur de saisir le nom du processus dont il veut surveiller la consommation d&rsquo;énergie et doit donc être définie au préalable (à la suite de la première) :</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">.addTemplate(
    template.datasource(
        <span style="color:#ed9d13">&#39;PROMETHEUS_DS&#39;</span>,
        <span style="color:#ed9d13">&#39;prometheus&#39;</span>,
        <span style="color:#ed9d13">&#39;Prometheus&#39;</span>,
        hide=<span style="color:#ed9d13">&#39;label&#39;</span>,
    )
)
.addTemplate(
    template.text(
        name=<span style="color:#ed9d13">&#39;process_filter&#39;</span>,
    )
)
</code></pre></div>
<p>Le résultat final :</p>
<p><img src="/grafonnet_sample_2.png" alt="Dashboard grafana"></p>
<p>Le fichier jsonnet final se trouve <a href="https://github.com/hubblo-org/scaphandre/blob/main/docker-compose/sample.jsonnet">ici</a>.</p>


        
          <div class="blog-tags">
            
              <a href="https://bpetit.nce.re/fr/tags/monitoring/">monitoring</a>&nbsp;
            
              <a href="https://bpetit.nce.re/fr/tags/grafana/">grafana</a>&nbsp;
            
              <a href="https://bpetit.nce.re/fr/tags/sre/">sre</a>&nbsp;
            
              <a href="https://bpetit.nce.re/fr/tags/automatisation/">automatisation</a>&nbsp;
            
              <a href="https://bpetit.nce.re/fr/tags/open-source/">open-source</a>&nbsp;
            
              <a href="https://bpetit.nce.re/fr/tags/devops/">devops</a>&nbsp;
            
              <a href="https://bpetit.nce.re/fr/tags/tech/">tech</a>&nbsp;
            
          </div>
        

        

        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://bpetit.nce.re/fr/2021/02/les-pratiques-sre-et-le-climat/" data-toggle="tooltip" data-placement="top" title="Les pratiques SRE et le climat">&larr; Post précédent</a>
            </li>
          
          
        </ul>
      


      

    </div>
  </div>
</div>

      
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
                <a href="mailto:bpetit@nce.re" title="Email me">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://github.com/bpetit" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://twitter.com/bpetit_" title="Twitter">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://linkedin.com/in/bepetit" title="LinkedIn">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          <li>
            <a href="" title="RSS">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              Benoit Petit
            
          

          &nbsp;&bull;&nbsp;&copy;
          
            2021
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://bpetit.nce.re/fr/">Benoit Petit</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          Carbure avec <a href="https://gohugo.io">Hugo v0.82.0</a>&nbsp;&bull;&nbsp; Avec le Theme <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> adapté de <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script src="https://bpetit.nce.re/js/katex.min.js"></script>
<script src="https://bpetit.nce.re/js/auto-render.min.js"></script>
<script src="https://bpetit.nce.re/js/jquery.min.js"></script>
<script src="https://bpetit.nce.re/js/bootstrap.min.js"></script>

<script src="https://bpetit.nce.re/js/main.js"></script><script> renderMathInElement(document.body); </script><script src="https://bpetit.nce.re/js/photoswipe.min.js"></script>
<script src="https://bpetit.nce.re/js/photoswipe-ui-default.min.js"></script><script src="https://bpetit.nce.re/js/load-photoswipe.js"></script>









    
  </body>
</html>


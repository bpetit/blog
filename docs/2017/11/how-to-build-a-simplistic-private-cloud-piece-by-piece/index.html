<!doctype html>
<html
  dir="ltr"
  lang="en"
  data-theme=""
  
    class="html theme--light"
  
><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8" />
  <title>
    Benoit Petit
        |
        How to build a simplistic private cloud piece by piece
      

    

  </title>

  <meta name="generator" content="Hugo 0.151.2"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="author" content="Benoit Petit" />
  <meta
    name="description"
    content="Co-founder of Hubblo and active contributor to Boavizta, analyzing the effects of Tech on the environment and society. ICT infrastructures and Datacenters specialist, IT system engineer. Open-Source developer. Read more in the About section."
  />
  
  
        <link rel="stylesheet" href="/css/anatole.css" />
      
  <link
    rel="stylesheet"
    href="/css/markupHighlight.min.73ccfdf28df555e11009c13c20ced067af3cb021504cba43644c705930428b00.css"
    integrity="sha256-c8z98o31VeEQCcE8IM7QZ688sCFQTLpDZExwWTBCiwA="
    crossorigin="anonymous"
    type="text/css"
  />
  
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/fontawesome.min.137b1cf3cea9a8adb7884343a9a5ddddf4280f59153f74dc782fb7f7bf0d0519.css"
    integrity="sha256-E3sc886pqK23iENDqaXd3fQoD1kVP3TceC&#43;3978NBRk="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/solid.min.e65dc5b48fb5f39b142360c57c3a215744c94e56c755c929cc3e88fe12aab4d3.css"
    integrity="sha256-5l3FtI&#43;185sUI2DFfDohV0TJTlbHVckpzD6I/hKqtNM="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/regular.min.6f4f16d58da1c82c0c3a3436e021a3d39b4742f741192c546e73e947eacfd92f.css"
    integrity="sha256-b08W1Y2hyCwMOjQ24CGj05tHQvdBGSxUbnPpR&#43;rP2S8="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/brands.min.e10425ad768bc98ff1fb272a0ac8420f9d1ba22f0612c08ff1010c95080ffe7e.css"
    integrity="sha256-4QQlrXaLyY/x&#43;ycqCshCD50boi8GEsCP8QEMlQgP/n4="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link rel="shortcut icon" href="/static/favicon.icofavicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/static/favicon.icoapple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon.icofavicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon.icofavicon-16x16.png" />

  <link rel="canonical" href="http://localhost:1313/2017/11/how-to-build-a-simplistic-private-cloud-piece-by-piece/" />
  
  
  
  
  <script
    type="text/javascript"
    src="/js/anatole-header.min.f9132794301a01ff16550ed66763482bd848f62243d278f5e550229a158bfd32.js"
    integrity="sha256-&#43;RMnlDAaAf8WVQ7WZ2NIK9hI9iJD0nj15VAimhWL/TI="
    crossorigin="anonymous"
  ></script>

  
    
    
    <script
      type="text/javascript"
      src="/js/anatole-theme-switcher.min.8724ddf9268dee451060f191961647573c7f592fbccc6d858746236b3f915813.js"
      integrity="sha256-hyTd&#43;SaN7kUQYPGRlhZHVzx/WS&#43;8zG2Fh0Yjaz&#43;RWBM="
      crossorigin="anonymous"
    ></script>
  

  

  

  


  
  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="How to build a simplistic private cloud piece by piece">
  <meta name="twitter:description" content="I you are, like me, concerned about privacy, you may be the administrator of a few physical servers, either at home or rented to some dedicated server providers. Virtual machine instances (or VPS) bought in public clouds are great, but if you can’t configure yourself the underlying network and the hypervisors, where is the fun ? (just kidding, there is so much to do above a cloud-like infrastructure too). Here I’ll describe a little configuration I made for my own needs. The purpose is to deploy automatically (via ansible) virtual machines, and the networks they rely on, on multiple debian 9 kvm hypervisors. The result is really basic compared to the feature you can get, either from a public cloud service or from a fully configured and integrated private cloud software suite (let’s say OpenStack). The idea here is not to provide a full featured infrastructure, but to build a lightweight IaaS infrastructure, piece by piece. Here we will focus on virtual machines deployment and basic networking, virtual machines disks will be stored on hypervisors local hard drives (yeah, not so good for live migration, but let’s keep some fun for later).">



  
  <meta property="og:url" content="http://localhost:1313/2017/11/how-to-build-a-simplistic-private-cloud-piece-by-piece/">
  <meta property="og:site_name" content="Benoit Petit&#39;s website">
  <meta property="og:title" content="How to build a simplistic private cloud piece by piece">
  <meta property="og:description" content="I you are, like me, concerned about privacy, you may be the administrator of a few physical servers, either at home or rented to some dedicated server providers. Virtual machine instances (or VPS) bought in public clouds are great, but if you can’t configure yourself the underlying network and the hypervisors, where is the fun ? (just kidding, there is so much to do above a cloud-like infrastructure too). Here I’ll describe a little configuration I made for my own needs. The purpose is to deploy automatically (via ansible) virtual machines, and the networks they rely on, on multiple debian 9 kvm hypervisors. The result is really basic compared to the feature you can get, either from a public cloud service or from a fully configured and integrated private cloud software suite (let’s say OpenStack). The idea here is not to provide a full featured infrastructure, but to build a lightweight IaaS infrastructure, piece by piece. Here we will focus on virtual machines deployment and basic networking, virtual machines disks will be stored on hypervisors local hard drives (yeah, not so good for live migration, but let’s keep some fun for later).">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2017-11-21T20:44:12+02:00">
    <meta property="article:modified_time" content="2017-11-21T20:44:12+02:00">
    <meta property="article:tag" content="Automation">
    <meta property="article:tag" content="Cloud">
    <meta property="article:tag" content="Ansible">
    <meta property="article:tag" content="Cloud-Init">
    <meta property="article:tag" content="Libvirt">
    <meta property="article:tag" content="Qemu">



  
  
  
  
  <script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "articleSection": "posts",
        "name": "How to build a simplistic private cloud piece by piece",
        "headline": "How to build a simplistic private cloud piece by piece",
        "alternativeHeadline": "",
        "description": "
      
        \u003cp\u003eI you are, like me, concerned about privacy, you may be the administrator of a few physical servers, either at home or rented to some dedicated server providers. Virtual machine instances (or VPS) bought in public clouds are great, but if you can\u0026rsquo;t configure yourself the underlying network and the hypervisors, where is the fun ? (just kidding, there is so much to do above a cloud-like infrastructure too). Here I\u0026rsquo;ll describe a little configuration I made for my own needs. The purpose is to deploy automatically (via ansible) virtual machines, and the networks they rely on, on multiple debian 9 kvm hypervisors. The result is really basic compared to the feature you can get, either from a public cloud service or from a fully configured and integrated private cloud software suite (let\u0026rsquo;s say OpenStack). The idea here is not to provide a full featured infrastructure, but to build a lightweight IaaS infrastructure, piece by piece. Here we will focus on virtual machines deployment and basic networking, virtual machines disks will be stored on hypervisors local hard drives (yeah, not so good for live migration, but let\u0026rsquo;s keep some fun for later).\u003c\/p\u003e


      


    ",
        "license": "",
        
        "inLanguage": "en",
        "isFamilyFriendly": "true",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/localhost:1313\/2017\/11\/how-to-build-a-simplistic-private-cloud-piece-by-piece\/"
        },
        "author" : {
            "@type": "Person",
            "name": "Benoit Petit"
        },
        "creator" : {
            "@type": "Person",
            "name": "Benoit Petit"
        },
        "accountablePerson" : {
            "@type": "Person",
            "name": "Benoit Petit"
        },
        "copyrightHolder" : {
            "@type": "Person",
            "name": "Benoit Petit"
        },
        "dateCreated": "2017-11-21T20:44:12.00Z",
        "datePublished": "2017-11-21T20:44:12.00Z",
        "dateModified": "2017-11-21T20:44:12.00Z",
        "publisher":{
            "@type":"Organization",
            "name": "Benoit Petit",
            "url": "http://localhost:1313/",
            "logo": {
                "@type": "ImageObject",
                "url": "http:\/\/localhost:1313\/static\/favicon.icofavicon-32x32.png",
                "width":"32",
                "height":"32"
            }
        },
        "image": 
      [
      ]

    ,
        "url" : "http:\/\/localhost:1313\/2017\/11\/how-to-build-a-simplistic-private-cloud-piece-by-piece\/",
        "wordCount" : "2090",
        "genre" : [ ],
        "keywords" : [ 
      
      "automation"

    
      
        ,

      
      "cloud"

    
      
        ,

      
      "ansible"

    
      
        ,

      
      "cloud-init"

    
      
        ,

      
      "libvirt"

    
      
        ,

      
      "qemu"

    
      
        ,

      
      "kvm"

    
      
        ,

      
      "openvswitch"

    ]
    }
  </script>




  
  
  
</head>
<body class="body">
    <div class="wrapper">
      <aside
        
          class="wrapper__sidebar"
        
      ><div
  class="sidebar
    animated fadeInDown
  "
>
  <div class="sidebar__content">
    <div class="sidebar__introduction">
      <img
        class="sidebar__introduction-profileimage"
        src="/profile.jpeg"
        alt="profile picture"
      />
      
        <div class="sidebar__introduction-title">
          <a href="/"></a>
        </div>
      
      <div class="sidebar__introduction-description">
        <p>Co-founder of Hubblo and active contributor to Boavizta, analyzing the effects of Tech on the environment and society. ICT infrastructures and Datacenters specialist, IT system engineer. Open-Source developer. Read more in the About section.</p>
      </div>
    </div>
    <ul class="sidebar__list">
      
        <li class="sidebar__list-item">
          <a
            href="https://mastodon.green/@bpetit"
            target="_blank"
            rel="noopener me"
            aria-label="Mastodon"
            title="Mastodon"
          >
            <i class="fab fa-mastodon fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      
        <li class="sidebar__list-item">
          <a
            href="https://linkedin.com/in/bepetit"
            target="_blank"
            rel="noopener me"
            aria-label="Linkedin"
            title="Linkedin"
          >
            <i class="fab fa-linkedin fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      
        <li class="sidebar__list-item">
          <a
            href="https://github.com/bpetit"
            target="_blank"
            rel="noopener me"
            aria-label="Github"
            title="Github"
          >
            <i class="fab fa-github fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      
        <li class="sidebar__list-item">
          <a
            href="https://gitlab.com/bpetit1"
            target="_blank"
            rel="noopener me"
            aria-label="Gitlab"
            title="Gitlab"
          >
            <i class="fab fa-gitlab fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      
        <li class="sidebar__list-item">
          <a
            href="https://bsky.app/profile/did:plc:yrnndxpff3wqc7kedczen335"
            target="_blank"
            rel="noopener me"
            aria-label="Bluesky"
            title="Bluesky"
          >
            <i class="fab fa-bluesky fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      
        <li class="sidebar__list-item">
          <a
            href="mailto:bpetit@nce.re"
            target="_blank"
            rel="noopener me"
            aria-label="e-mail"
            title="e-mail"
          >
            <i class="fas fa-envelope fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      
    </ul>
  </div><footer class="footer footer__sidebar">
  <ul class="footer__list">
    <li class="footer__item">
      &copy;
      
        Benoit Petit
        2025
      
    </li>
    
  </ul>
</footer>
  
  <script
    type="text/javascript"
    src="/js/medium-zoom.min.9531b4a2217a70c5a1fce89c1f81c9ebbdd586708fcd4130b417320c7230c8d6.js"
    integrity="sha256-lTG0oiF6cMWh/OicH4HJ673VhnCPzUEwtBcyDHIwyNY="
    crossorigin="anonymous"
  ></script></div>
</aside>
      <main
        
          class="wrapper__main"
        
      >
        <header class="header"><div
  class="
    animated fadeInDown
  "
>
  <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
    <span aria-hidden="true" class="navbar-burger__line"></span>
    <span aria-hidden="true" class="navbar-burger__line"></span>
    <span aria-hidden="true" class="navbar-burger__line"></span>
  </a>
  <nav class="nav">
    <ul class="nav__list" id="navMenu">
      
      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="/"
              
              title=""
              >Home</a
            >
          </li>
        

      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="/posts"
              
              title=""
              >Blog</a
            >
          </li>
        

      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="/page/about/"
              
              title=""
              >About</a
            >
          </li>
        

      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="/page/press/"
              
              title=""
              >Press</a
            >
          </li>
        

      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="/page/talks/"
              
              title=""
              >Talks</a
            >
          </li>
        

      
    </ul>
    <ul class="nav__list nav__list--end">
      
      
        <li class="nav__list-item">
          <div class="themeswitch">
            <a title="Switch Theme">
              <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a>
          </div>
        </li>
      
    </ul>
  </nav>
</div>
</header>
  <div
    class="post 
      animated fadeInDown
    "
  >
    
    <div class="post__content">
      
        <h1>How to Build a Simplistic Private Cloud Piece by Piece</h1>
      
      <h3>Table of contents</h3>
<nav id="TableOfContents">
  <ul>
    <li><a href="#project-workflow">Project workflow</a>
      <ul>
        <li><a href="#0-requirements-installation">0. Requirements installation</a></li>
        <li><a href="#1-openvswitch-configuration">1. Openvswitch configuration</a></li>
        <li><a href="#4-cloud-init-configuration-and-libvirt-domain-creation">4. Cloud-init configuration and libvirt domain creation</a></li>
        <li><a href="#5-define-domain-and-boot-the-guest">5. Define domain and boot the guest</a></li>
      </ul>
    </li>
    <li><a href="#feed-the-variables-host_vars-and-group_vars">Feed the variables: host_vars and group_vars</a></li>
    <li><a href="#flaws">Flaws</a></li>
  </ul>
</nav>
<p>I you are, like me, concerned about privacy, you may be the administrator of a few physical servers, either at home or rented to some dedicated server providers. Virtual machine instances (or VPS) bought in public clouds are great, but if you can&rsquo;t configure yourself the underlying network and the hypervisors, where is the fun ? (just kidding, there is so much to do above a cloud-like infrastructure too). Here I&rsquo;ll describe a little configuration I made for my own needs. The purpose is to deploy automatically (via ansible) virtual machines, and the networks they rely on, on multiple debian 9 kvm hypervisors. The result is really basic compared to the feature you can get, either from a public cloud service or from a fully configured and integrated private cloud software suite (let&rsquo;s say OpenStack). The idea here is not to provide a full featured infrastructure, but to build a lightweight IaaS infrastructure, piece by piece. Here we will focus on virtual machines deployment and basic networking, virtual machines disks will be stored on hypervisors local hard drives (yeah, not so good for live migration, but let&rsquo;s keep some fun for later).</p>
<p>First, let&rsquo;s present the building blocks of this workshop:</p>
<ul>
<li>Packer: description here, permits to build fresh virtual machine images from a json template</li>
<li>Ansible: a well known configuration management tool (see Infrastructure As Code), we will use it to apply every needed configuration on the hypervisors.</li>
<li>Cloud-init: a python software which, preinstalled on a virtual machine, is able to run some configuration tasks during the boot sequence. Cloud-init is able to read configuration it has to apply from multiple data sources like OpenStack or AWS APIs, if the virtual machine is in that context, or simply from a locally attached iso containing the right configuration files. It kinda became the de-facto standard for guests pre-configuration in cloud environments. It is also very handy to avoid dependencies to DHCP servers in your infrastructure (that&rsquo;s the main usage here).</li>
<li>OpenVSwitch: is swiss army knife virtual switch software. The use case in this article is very simple: interconnecting virtual machines, we could have used simple linux bridges for that. However, building the network basics of the IaaS on such a rich software will allow us to address much more use cases in the future (let&rsquo;s say automatically mounting VXLAN and/or IPSec tunnels between our hypervisors, have network readability with sFlow&hellip;)</li>
<li>libvirt: the virtualization API, here used above Qemu/KVM. We will present some libvirt xml configuration files in this article (jinja2 templates in fact, used via Ansible)</li>
</ul>
<p>Now we know what our tools are for, we will describe the worflow of this tiny project.</p>
<p><img src="../../../iaas-workflow-1.png" alt="playbook worflow"></p>
<h2 id="project-workflow">Project workflow</h2>
<p>Let&rsquo;s describe each step a bit more precisely.</p>
<h3 id="0-requirements-installation">0. Requirements installation</h3>
<p>First we have to install all required packages on the hypervisors, for qemu-kvm, libvirt, openvswitch, and some utils (vlans could be usefull to).</p>
<div class="highlight"><div style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">34
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#6ab825;font-weight:bold">hosts</span>:<span style="color:#666"> </span>kvm<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">  </span><span style="color:#6ab825;font-weight:bold">tasks</span>:<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span>- <span style="color:#6ab825;font-weight:bold">apt</span>:<span style="color:#666"> </span>update_cache={{ kvm_update_apt_cache | default(&#39;yes&#39;) }} state=present name={{ item }}<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">      </span><span style="color:#6ab825;font-weight:bold">with_items</span>:<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">        </span>- bridge-utils<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">        </span>- debootstrap<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">        </span>- ifenslave<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">        </span>- ifenslave-2.6<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">        </span>- lsof<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">        </span>- ntp<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">        </span>- ntpdate<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">        </span>- tcpdump<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">        </span>- vlan<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">        </span>- virt-top<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">        </span>- libvirt0<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">        </span>- python-libvirt<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">        </span>- virtinst<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">        </span>- qemu-kvm<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">        </span>- genisoimage<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">        </span>- openvswitch-switch<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">        </span>- openvswitch-common<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">        </span>- openvswitch-vtep<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">        </span>- python-openvswitch<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span>- <span style="color:#6ab825;font-weight:bold">apt</span>:<span style="color:#666"> </span>state=present name=libvirt-bin<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">      </span><span style="color:#6ab825;font-weight:bold">when</span>:<span style="color:#666"> </span>ansible_distribution_major_version &lt; 9 and ansible_distribution == &#39;Debian&#39;<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span>- <span style="color:#6ab825;font-weight:bold">apt</span>:<span style="color:#666"> </span>state=present name={{ item }}<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">      </span><span style="color:#6ab825;font-weight:bold">when</span>:<span style="color:#666"> </span>ansible_distribution_major_version &gt;= 9 and ansible_distribution == &#39;Debian&#39; or ansible_distribution == &#39;Ubuntu&#39;<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">      </span><span style="color:#6ab825;font-weight:bold">with_items</span>:<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">        </span>- libvirt-daemon-system<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">        </span>- libvirt-clients<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span>- <span style="color:#6ab825;font-weight:bold">modprobe</span>:<span style="color:#666"> </span>name={{ item }} state=present<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">      </span><span style="color:#6ab825;font-weight:bold">with_items</span>:<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">        </span>- bonding<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">        </span>- 8021q</span></span></code></pre></td></tr></table>
</div>
</div>
<h3 id="1-openvswitch-configuration">1. Openvswitch configuration</h3>
<p>Now we have to configure ovs bridges in order to allow attaching new virtual network interfaces to thoses bridges. Creating persistent ovs ports is also interessting (it will be when we&rsquo;ll deploys ipsec tunnels between hypervisors the next article). You surely noted the with_items parameter. That way, we will be able to call those playbooks with a dictionnary as parameter and run them with multiple datasets.</p>
<p>In the main playbook:</p>
<div class="highlight"><div style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#6ab825;font-weight:bold">include</span>:<span style="color:#666"> </span>ovs/bridges.yml<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">  </span><span style="color:#6ab825;font-weight:bold">with_items</span>:<span style="color:#666"> </span><span style="color:#ed9d13">&#34;{{ ovs.bridges }}&#34;</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">  </span><span style="color:#6ab825;font-weight:bold">when</span>:<span style="color:#666"> </span>ovs.bridges is defined<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">  </span><span style="color:#6ab825;font-weight:bold">tags</span>:<span style="color:#666"> </span>ovs<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666"></span>- <span style="color:#6ab825;font-weight:bold">include</span>:<span style="color:#666"> </span>ovs/ports.yml<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">  </span><span style="color:#6ab825;font-weight:bold">with_items</span>:<span style="color:#666"> </span><span style="color:#ed9d13">&#34;{{ ovs.ports }}&#34;</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">  </span><span style="color:#6ab825;font-weight:bold">when</span>:<span style="color:#666"> </span>ovs.ports is defined<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">  </span><span style="color:#6ab825;font-weight:bold">tags</span>:<span style="color:#666"> </span>ovs</span></span></code></pre></td></tr></table>
</div>
</div>
<p>If we have a look at the bridges.yml playbook:</p>
<div class="highlight"><div style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#6ab825;font-weight:bold">openvswitch_bridge</span>:<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">bridge</span>:<span style="color:#666"> </span><span style="color:#ed9d13">&#34;{{ item.name }}&#34;</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">state</span>:<span style="color:#666"> </span><span style="color:#ed9d13">&#34;{{ item.state | default(&#39;present&#39;) }}&#34;</span></span></span></code></pre></td></tr></table>
</div>
</div>
<p>Yes, it&rsquo;s really simple, according to the needs of this article. You could easily improve that task by using other parameters from the openvswith_bridge module.</p>
<p>In the <code>ports.yml</code> playbook:</p>
<div class="highlight"><div style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#6ab825;font-weight:bold">name</span>:<span style="color:#666"> </span>define ovs port configuration<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">  </span><span style="color:#6ab825;font-weight:bold">template</span>:<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">src</span>:<span style="color:#666"> </span>templates/ovs_interfaces.j2<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">dest</span>:<span style="color:#666"> </span><span style="color:#ed9d13">&#34;/etc/network/interfaces.d/ovs_port_{{ item.port }}&#34;</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666"></span>- <span style="color:#6ab825;font-weight:bold">name</span>:<span style="color:#666"> </span>include configuration<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">  </span><span style="color:#6ab825;font-weight:bold">lineinfile</span>:<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">path</span>:<span style="color:#666"> </span>/etc/network/interfaces<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">line</span>:<span style="color:#666"> </span><span style="color:#ed9d13">&#34;source /etc/network/interfaces.d/ovs_port_{{ item.port }}&#34;</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666"></span>- <span style="color:#6ab825;font-weight:bold">name</span>:<span style="color:#666"> </span>ensure interface is up<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">  </span><span style="color:#6ab825;font-weight:bold">shell</span>:<span style="color:#666"> </span><span style="color:#ed9d13">&#34;ifup {{ item.port }}&#34;</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">  </span><span style="color:#6ab825;font-weight:bold">ignore_errors</span>:<span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">yes</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">  </span><span style="color:#6ab825;font-weight:bold">when</span>:<span style="color:#666"> </span>item.state is not defined or item.state == &#39;present&#39;<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666"></span>- <span style="color:#6ab825;font-weight:bold">name</span>:<span style="color:#666"> </span>ensure interface is down<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">  </span><span style="color:#6ab825;font-weight:bold">shell</span>:<span style="color:#666"> </span><span style="color:#ed9d13">&#34;ifdown {{ item.port }}&#34;</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">  </span><span style="color:#6ab825;font-weight:bold">ignore_errors</span>:<span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">yes</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">  </span><span style="color:#6ab825;font-weight:bold">when</span>:<span style="color:#666"> </span>item.state is defined and item.state == &#39;absent&#39;</span></span></code></pre></td></tr></table>
</div>
</div>
<p>Here we set ovs ports configuration directly in the network/interfaces.d directory (Debian environment). The <code>ovs_interfaces.j2</code> template looks like this:</p>
<div class="highlight"><div style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jinja" data-lang="jinja"><span style="display:flex;"><span>allow-vmbr-int <span style="color:#cd2828;font-weight:bold">{{</span> <span style="color:#40ffff">item.port</span> <span style="color:#cd2828;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span>iface <span style="color:#cd2828;font-weight:bold">{{</span> <span style="color:#40ffff">item.port</span> <span style="color:#cd2828;font-weight:bold">}}</span> inet <span style="color:#cd2828;font-weight:bold">{{</span> <span style="color:#40ffff">item.mode</span> | <span style="color:#447fcf">default</span>(<span style="color:#ed9d13">&#39;manual&#39;</span>) <span style="color:#cd2828;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span>  ovs_bridge <span style="color:#cd2828;font-weight:bold">{{</span> <span style="color:#40ffff">item.bridge</span> <span style="color:#cd2828;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span>  ovs_type OVSIntPort
</span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">{%</span> <span style="color:#6ab825;font-weight:bold">if</span> <span style="color:#40ffff">item.tag</span> <span style="color:#6ab825;font-weight:bold">is</span> <span style="color:#447fcf">defined</span> <span style="color:#cd2828;font-weight:bold">%}</span>
</span></span><span style="display:flex;"><span>  ovs_options tag=<span style="color:#cd2828;font-weight:bold">{{</span> <span style="color:#40ffff">item.tag</span> <span style="color:#cd2828;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">{%</span> <span style="color:#6ab825;font-weight:bold">endif</span> <span style="color:#cd2828;font-weight:bold">%}</span>
</span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">{%</span> <span style="color:#6ab825;font-weight:bold">if</span> <span style="color:#40ffff">item.address</span> <span style="color:#6ab825;font-weight:bold">is</span> <span style="color:#447fcf">defined</span> <span style="color:#6ab825;font-weight:bold">and</span> <span style="color:#40ffff">item.netmask</span> <span style="color:#6ab825;font-weight:bold">is</span> <span style="color:#447fcf">defined</span> <span style="color:#cd2828;font-weight:bold">%}</span>
</span></span><span style="display:flex;"><span>  address <span style="color:#cd2828;font-weight:bold">{{</span> <span style="color:#40ffff">item.address</span> <span style="color:#cd2828;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span>  netmask <span style="color:#cd2828;font-weight:bold">{{</span> <span style="color:#40ffff">item.netmask</span> <span style="color:#cd2828;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">{%</span> <span style="color:#6ab825;font-weight:bold">endif</span> <span style="color:#cd2828;font-weight:bold">%}</span></span></span></code></pre></td></tr></table>
</div>
</div>
<p>Here we define a layer 3 interface that will basically permit to ping our virtual machines and validate the POC (and, because I use isolated dedicated servers on the Internet, it will permit me to route traffic from and to virtual machines). I&rsquo;ll address more interesting use cases in next posts.
2. Building guest OS image with packer</p>
<p>We will build guest OS images with Packer. You can check my last post to read about packer or see example configuration. What is new here is that we will use cloud-init, so we have to install it on the guest OS. We will do guest provisioning with ansible, because ansible is great. In the packer json template we need:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#ed9d13">&#34;provisioners&#34;</span><span style="color:#a61717;background-color:#e3d2d2">:</span> [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">&#34;type&#34;</span>: <span style="color:#ed9d13">&#34;ansible&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">&#34;playbook_file&#34;</span>: <span style="color:#ed9d13">&#34;./ansible/playbook.yml&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>]<span style="color:#a61717;background-color:#e3d2d2">,</span>
</span></span><span style="display:flex;"><span><span style="color:#ed9d13">&#34;post-processors&#34;</span><span style="color:#a61717;background-color:#e3d2d2">:</span> [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">&#34;type&#34;</span>: <span style="color:#ed9d13">&#34;compress&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">&#34;output&#34;</span>: <span style="color:#ed9d13">&#34;template-debian-9.qcow2.tar.gz&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>]</span></span></code></pre></div>
<p>(The post-processors is here to compress the image before we copy it on the hypervisor, yes we should checksum to).</p>
<p>The playbook should simply contain:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#6ab825;font-weight:bold">apt</span>:<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">name</span>:<span style="color:#666"> </span>cloud-init<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">state</span>:<span style="color:#666"> </span>present</span></span></code></pre></div>
<ol start="3">
<li>Give libvirt access to the virtual machine disk file</li>
</ol>
<p>This is self explanatory.</p>
<div class="highlight"><div style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#6ab825;font-weight:bold">name</span>:<span style="color:#666"> </span>install utils<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">  </span><span style="color:#6ab825;font-weight:bold">apt</span>:<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">name</span>:<span style="color:#666"> </span>gzip<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">state</span>:<span style="color:#666"> </span>present<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666"></span>- <span style="color:#6ab825;font-weight:bold">name</span>:<span style="color:#666"> </span>creating VM folder<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">  </span><span style="color:#6ab825;font-weight:bold">file</span>:<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">path</span>:<span style="color:#666"> </span><span style="color:#ed9d13">&#34;/var/lib/libvirt/images/{{ item.name }}&#34;</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">state</span>:<span style="color:#666"> </span>directory<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">mode</span>:<span style="color:#666"> </span><span style="color:#3677a9">0755</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666"></span>- <span style="color:#6ab825;font-weight:bold">name</span>:<span style="color:#666"> </span>copy image disk archive<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">  </span><span style="color:#6ab825;font-weight:bold">copy</span>:<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">src</span>:<span style="color:#666"> </span><span style="color:#ed9d13">&#34;./files/{{ item.archive_name }}.tar.gz&#34;</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">dest</span>:<span style="color:#666"> </span><span style="color:#ed9d13">&#34;/var/lib/libvirt/images/{{ item.archive_name }}.tar.gz&#34;</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">owner</span>:<span style="color:#666"> </span><span style="color:#ed9d13">&#34;{{ item.kvm_qemu_user | default(&#39;libvirt-qemu&#39;) }}&#34;</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">group</span>:<span style="color:#666"> </span><span style="color:#ed9d13">&#34;{{ item.kvm_qemu_group | default(&#39;libvirt-qemu&#39;) }}&#34;</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">mode</span>:<span style="color:#666"> </span><span style="color:#3677a9">0644</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666"></span>- <span style="color:#6ab825;font-weight:bold">name</span>:<span style="color:#666"> </span>unarchive disk<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">  </span><span style="color:#6ab825;font-weight:bold">unarchive</span>:<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">src</span>:<span style="color:#666"> </span><span style="color:#ed9d13">&#34;/var/lib/libvirt/images/{{ item.archive_name }}.tar.gz&#34;</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">dest</span>:<span style="color:#666"> </span><span style="color:#ed9d13">&#34;/var/lib/libvirt/images/{{ item.name }}&#34;</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">copy</span>:<span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">no</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">  </span><span style="color:#6ab825;font-weight:bold">ignore_errors</span>:<span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">yes</span></span></span></code></pre></td></tr></table>
</div>
</div>
<h3 id="4-cloud-init-configuration-and-libvirt-domain-creation">4. Cloud-init configuration and libvirt domain creation</h3>
<p>Cloud-init is able to take its configuration from a locally mounted iso file. We need to create that iso file on the hypervisors, including meta-data and user-data configuration files.</p>
<div class="highlight"><div style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#6ab825;font-weight:bold">name</span>:<span style="color:#666"> </span>cloud-init user data<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">  </span><span style="color:#6ab825;font-weight:bold">template</span>:<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">src</span>:<span style="color:#666"> </span><span style="color:#ed9d13">&#34;libvirt/user-data.j2&#34;</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">dest</span>:<span style="color:#666"> </span><span style="color:#ed9d13">&#34;/var/lib/libvirt/images/{{ item.name }}/user-data&#34;</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666"></span>- <span style="color:#6ab825;font-weight:bold">name</span>:<span style="color:#666"> </span>cloud-init meta data<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">  </span><span style="color:#6ab825;font-weight:bold">template</span>:<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">src</span>:<span style="color:#666"> </span><span style="color:#ed9d13">&#34;libvirt/meta-data.j2&#34;</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">dest</span>:<span style="color:#666"> </span><span style="color:#ed9d13">&#34;/var/lib/libvirt/images/{{ item.name }}/meta-data&#34;</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666"></span>- <span style="color:#6ab825;font-weight:bold">name</span>:<span style="color:#666"> </span>cloud-init iso<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">  </span><span style="color:#6ab825;font-weight:bold">shell</span>:<span style="color:#666"> </span>/usr/bin/genisoimage -o {{ item.cloudinit_file | default(&#39;cloud-init&#39;) }}_ci.iso -V cidata -r -J user-data meta-data<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">  </span><span style="color:#6ab825;font-weight:bold">args</span>:<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">chdir</span>:<span style="color:#666"> </span><span style="color:#ed9d13">&#34;/var/lib/libvirt/images/{{ item.name }}/&#34;</span></span></span></code></pre></td></tr></table>
</div>
</div>
<p>Note the shell task: we build a fresh iso image containing our cloud-init data files. This iso will be mounted as a cd by libvirt, when the guest is booting.</p>
<p>Here are the templates:</p>
<p><code>meta-data.j2</code> is really basic:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jinja" data-lang="jinja"><span style="display:flex;"><span>local-hostname: <span style="color:#cd2828;font-weight:bold">{{</span> <span style="color:#40ffff">item.hostname</span> <span style="color:#cd2828;font-weight:bold">}}</span></span></span></code></pre></div>
<p>in <code>user-data.j2</code> we find the network configuration of the guest:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jinja" data-lang="jinja"><span style="display:flex;"><span>#cloud-config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>write_files:
</span></span><span style="display:flex;"><span>  - content: |
</span></span><span style="display:flex;"><span>      # This file describes the network interfaces available on your system
</span></span><span style="display:flex;"><span>      # and how to activate them. For more information, see interfaces(5).
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      # The loopback network interface
</span></span><span style="display:flex;"><span>      auto lo
</span></span><span style="display:flex;"><span>      iface lo inet loopback
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">{%</span> <span style="color:#6ab825;font-weight:bold">for</span> <span style="color:#40ffff">interface</span> <span style="color:#6ab825;font-weight:bold">in</span> <span style="color:#40ffff">item.interfaces</span> <span style="color:#cd2828;font-weight:bold">%}</span>
</span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">{%</span> <span style="color:#6ab825;font-weight:bold">if</span> <span style="color:#40ffff">interface.comment</span> <span style="color:#6ab825;font-weight:bold">is</span> <span style="color:#447fcf">defined</span> <span style="color:#cd2828;font-weight:bold">%}</span>
</span></span><span style="display:flex;"><span>      # <span style="color:#cd2828;font-weight:bold">{{</span> <span style="color:#40ffff">interface.comment</span> <span style="color:#cd2828;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">{%</span> <span style="color:#6ab825;font-weight:bold">endif</span> <span style="color:#cd2828;font-weight:bold">%}</span>
</span></span><span style="display:flex;"><span>      auto <span style="color:#cd2828;font-weight:bold">{{</span> <span style="color:#40ffff">interface.name</span> <span style="color:#cd2828;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span>      iface <span style="color:#cd2828;font-weight:bold">{{</span> <span style="color:#40ffff">interface.name</span> <span style="color:#cd2828;font-weight:bold">}}</span> inet <span style="color:#cd2828;font-weight:bold">{{</span> <span style="color:#40ffff">interface.mode</span> <span style="color:#cd2828;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span>              address <span style="color:#cd2828;font-weight:bold">{{</span> <span style="color:#40ffff">interface.address</span> <span style="color:#cd2828;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span>              netmask <span style="color:#cd2828;font-weight:bold">{{</span> <span style="color:#40ffff">interface.netmask</span> <span style="color:#cd2828;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">{%</span> <span style="color:#6ab825;font-weight:bold">if</span> <span style="color:#40ffff">interface.gateway</span> <span style="color:#6ab825;font-weight:bold">is</span> <span style="color:#447fcf">defined</span> <span style="color:#cd2828;font-weight:bold">%}</span>
</span></span><span style="display:flex;"><span>              gateway <span style="color:#cd2828;font-weight:bold">{{</span> <span style="color:#40ffff">interface.gateway</span> <span style="color:#cd2828;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">{%</span> <span style="color:#6ab825;font-weight:bold">endif</span> <span style="color:#cd2828;font-weight:bold">%}</span>
</span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">{%</span> <span style="color:#6ab825;font-weight:bold">if</span> <span style="color:#40ffff">interface.dns</span> <span style="color:#6ab825;font-weight:bold">is</span> <span style="color:#447fcf">defined</span> <span style="color:#cd2828;font-weight:bold">%}</span>
</span></span><span style="display:flex;"><span>              dns-nameservers <span style="color:#cd2828;font-weight:bold">{{</span> <span style="color:#40ffff">interface.dns</span> | <span style="color:#447fcf">default</span>(<span style="color:#ed9d13">&#39;9.9.9.9&#39;</span>) <span style="color:#cd2828;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">{%</span> <span style="color:#6ab825;font-weight:bold">endif</span> <span style="color:#cd2828;font-weight:bold">%}</span>
</span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">{%</span> <span style="color:#6ab825;font-weight:bold">endfor</span> <span style="color:#cd2828;font-weight:bold">%}</span>
</span></span><span style="display:flex;"><span>    path: /etc/network/interfaces</span></span></code></pre></div>
<h3 id="5-define-domain-and-boot-the-guest">5. Define domain and boot the guest</h3>
<p>I won&rsquo;t paste the whole libvirt domain template as this blog post is already too long. Here are the two specific parts, the domain xml required to mount the cloud-init configuration iso:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">&lt;disk</span> <span style="color:#bbb">type=</span><span style="color:#ed9d13">&#39;file&#39;</span> <span style="color:#bbb">device=</span><span style="color:#ed9d13">&#39;cdrom&#39;</span><span style="color:#6ab825;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#6ab825;font-weight:bold">&lt;driver</span> <span style="color:#bbb">name=</span><span style="color:#ed9d13">&#39;qemu&#39;</span> <span style="color:#bbb">type=</span><span style="color:#ed9d13">&#39;raw&#39;</span><span style="color:#6ab825;font-weight:bold">/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#6ab825;font-weight:bold">&lt;source</span> <span style="color:#bbb">file=</span><span style="color:#ed9d13">&#39;/var/lib/libvirt/images/{{ item.name }}/{{ item.cloudinit_file | default(&#39;</span><span style="color:#a61717;background-color:#e3d2d2">cloud-init&#39;)</span> <span style="color:#a61717;background-color:#e3d2d2">}}_ci.iso&#39;</span><span style="color:#6ab825;font-weight:bold">/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#6ab825;font-weight:bold">&lt;target</span> <span style="color:#bbb">dev=</span><span style="color:#ed9d13">&#39;hdc&#39;</span> <span style="color:#bbb">bus=</span><span style="color:#ed9d13">&#39;ide&#39;</span><span style="color:#6ab825;font-weight:bold">/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#6ab825;font-weight:bold">&lt;readonly/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#6ab825;font-weight:bold">&lt;address</span> <span style="color:#bbb">type=</span><span style="color:#ed9d13">&#39;drive&#39;</span> <span style="color:#bbb">controller=</span><span style="color:#ed9d13">&#39;0&#39;</span> <span style="color:#bbb">bus=</span><span style="color:#ed9d13">&#39;1&#39;</span> <span style="color:#bbb">target=</span><span style="color:#ed9d13">&#39;0&#39;</span> <span style="color:#bbb">unit=</span><span style="color:#ed9d13">&#39;0&#39;</span><span style="color:#6ab825;font-weight:bold">/&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">&lt;/disk&gt;</span></span></span></code></pre></div>
<p>and the one required to create virtual network interfaces, for that virtual machine, attached to ovs bridges we created earlier:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jinja" data-lang="jinja"><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">{%</span> <span style="color:#6ab825;font-weight:bold">if</span> <span style="color:#40ffff">item.ovs</span> <span style="color:#6ab825;font-weight:bold">is</span> <span style="color:#447fcf">defined</span> <span style="color:#cd2828;font-weight:bold">%}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cd2828;font-weight:bold">{%</span> <span style="color:#6ab825;font-weight:bold">for</span> <span style="color:#40ffff">ovsbr</span> <span style="color:#6ab825;font-weight:bold">in</span> <span style="color:#40ffff">item.ovs</span> <span style="color:#cd2828;font-weight:bold">%}</span>
</span></span><span style="display:flex;"><span>    &lt;interface type=&#39;bridge&#39;&gt;
</span></span><span style="display:flex;"><span>      &lt;virtualport type=&#39;openvswitch&#39;&gt;&lt;/virtualport&gt;
</span></span><span style="display:flex;"><span>      &lt;model type=&#39;virtio&#39;/&gt;
</span></span><span style="display:flex;"><span>      &lt;target dev=&#39;veth-<span style="color:#cd2828;font-weight:bold">{{</span> <span style="color:#40ffff">item.name</span> <span style="color:#cd2828;font-weight:bold">}}</span>&#39;/&gt;
</span></span><span style="display:flex;"><span>      &lt;source bridge=&#39;<span style="color:#cd2828;font-weight:bold">{{</span> <span style="color:#40ffff">ovsbr.name</span> <span style="color:#cd2828;font-weight:bold">}}</span>&#39;/&gt;
</span></span><span style="display:flex;"><span>      <span style="color:#cd2828;font-weight:bold">{%</span> <span style="color:#6ab825;font-weight:bold">if</span> <span style="color:#40ffff">ovsbr.vlans</span> <span style="color:#6ab825;font-weight:bold">is</span> <span style="color:#447fcf">defined</span> <span style="color:#cd2828;font-weight:bold">%}</span>
</span></span><span style="display:flex;"><span>        &lt;vlan&gt;
</span></span><span style="display:flex;"><span>        <span style="color:#cd2828;font-weight:bold">{%</span> <span style="color:#6ab825;font-weight:bold">for</span> <span style="color:#40ffff">vlan</span> <span style="color:#6ab825;font-weight:bold">in</span> <span style="color:#40ffff">ovsbr.vlans</span> <span style="color:#cd2828;font-weight:bold">%}</span>
</span></span><span style="display:flex;"><span>          &lt;tag id=&#39;<span style="color:#cd2828;font-weight:bold">{{</span> <span style="color:#40ffff">vlan</span> <span style="color:#cd2828;font-weight:bold">}}</span>&#39;/&gt;
</span></span><span style="display:flex;"><span>        <span style="color:#cd2828;font-weight:bold">{%</span> <span style="color:#6ab825;font-weight:bold">endfor</span> <span style="color:#cd2828;font-weight:bold">%}</span>
</span></span><span style="display:flex;"><span>        &lt;/vlan&gt;
</span></span><span style="display:flex;"><span>      <span style="color:#cd2828;font-weight:bold">{%</span> <span style="color:#6ab825;font-weight:bold">endif</span> <span style="color:#cd2828;font-weight:bold">%}</span>
</span></span><span style="display:flex;"><span>    &lt;/interface&gt;
</span></span><span style="display:flex;"><span>  <span style="color:#cd2828;font-weight:bold">{%</span> <span style="color:#6ab825;font-weight:bold">endfor</span> <span style="color:#cd2828;font-weight:bold">%}</span>
</span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">{%</span> <span style="color:#6ab825;font-weight:bold">endif</span> <span style="color:#cd2828;font-weight:bold">%}</span></span></span></code></pre></div>
<p>Note that this configuration takes into account vlan tags (with the block ), you can then attach an interface in access mode on a specific vlan and isolate trafic between virtual machines from different groups.</p>
<p>And then, the ansible tasks to deploy the new domain:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#6ab825;font-weight:bold">name</span>:<span style="color:#666"> </span>defining VM domain<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">  </span><span style="color:#6ab825;font-weight:bold">virt</span>:<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">name</span>:<span style="color:#666"> </span><span style="color:#ed9d13">&#34;{{ item.name }}&#34;</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">command</span>:<span style="color:#666"> </span>define<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">xml</span>:<span style="color:#666"> </span><span style="color:#ed9d13">&#34;{{ lookup(&#39;template&#39;, &#39;libvirt/domain.xml.j2&#39;) }}&#34;</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">uri</span>:<span style="color:#666"> </span><span style="color:#ed9d13">&#34;qemu:///system&#34;</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">  </span><span style="color:#6ab825;font-weight:bold">tags</span>:<span style="color:#666"> </span>define<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666"></span>- <span style="color:#6ab825;font-weight:bold">name</span>:<span style="color:#666"> </span>VM state<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">  </span><span style="color:#6ab825;font-weight:bold">virt</span>:<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">name</span>:<span style="color:#666"> </span><span style="color:#ed9d13">&#34;{{ item.name }}&#34;</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">state</span>:<span style="color:#666"> </span>running<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">uri</span>:<span style="color:#666"> </span><span style="color:#ed9d13">&#34;qemu:///system&#34;</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">  </span><span style="color:#6ab825;font-weight:bold">tags</span>:<span style="color:#666"> </span>start</span></span></code></pre></div>
<h2 id="feed-the-variables-host_vars-and-group_vars">Feed the variables: host_vars and group_vars</h2>
<p>If you reached those lines, first thank you (that post is a bit long, I&rsquo;m a new comer in terms of blogging). Second, you may want to see a vars file sample, to make all those configurations alive. Here it is:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">ovs</span>:<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">bridges</span>:<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">      </span>- <span style="color:#6ab825;font-weight:bold">name</span>:<span style="color:#666"> </span>ovs-wan1<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">        </span><span style="color:#6ab825;font-weight:bold">state</span>:<span style="color:#666"> </span>present<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">ports</span>:<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">      </span>- <span style="color:#6ab825;font-weight:bold">bridge</span>:<span style="color:#666"> </span>ovs-wan1<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">        </span><span style="color:#6ab825;font-weight:bold">port</span>:<span style="color:#666"> </span>itc-wan1<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">        </span><span style="color:#6ab825;font-weight:bold">tag</span>:<span style="color:#666"> </span><span style="color:#3677a9">25</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">        </span><span style="color:#6ab825;font-weight:bold">mode</span>:<span style="color:#666"> </span>static<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">        </span><span style="color:#6ab825;font-weight:bold">address</span>:<span style="color:#666"> </span><span style="color:#3677a9">192.168.192.129</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">        </span><span style="color:#6ab825;font-weight:bold">netmask</span>:<span style="color:#666"> </span><span style="color:#3677a9">255.255.255.248</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">vms</span>:<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">  </span>- <span style="color:#6ab825;font-weight:bold">name</span>:<span style="color:#666"> </span>test<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">hostname</span>:<span style="color:#666"> </span>test<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">disk_name</span>:<span style="color:#666"> </span>template-debian-9<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">memory</span>:<span style="color:#666"> </span><span style="color:#3677a9">512024</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">archive_name</span>:<span style="color:#666"> </span>template-debian-9.qcow2<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">ovs</span>:<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">      </span>- <span style="color:#6ab825;font-weight:bold">name</span>:<span style="color:#666"> </span>ovs-wan1<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">        </span><span style="color:#6ab825;font-weight:bold">vlans</span>:<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">          </span>- <span style="color:#3677a9">25</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">interfaces</span>:<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">      </span>- <span style="color:#6ab825;font-weight:bold">name</span>:<span style="color:#666"> </span>eth0<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">        </span><span style="color:#6ab825;font-weight:bold">mode</span>:<span style="color:#666"> </span>static<span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">        </span><span style="color:#6ab825;font-weight:bold">address</span>:<span style="color:#666"> </span><span style="color:#3677a9">192.168.192.130</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">        </span><span style="color:#6ab825;font-weight:bold">netmask</span>:<span style="color:#666"> </span><span style="color:#3677a9">255.255.255.248</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span><span style="color:#666">        </span><span style="color:#6ab825;font-weight:bold">gateway</span>:<span style="color:#666"> </span><span style="color:#3677a9">192.168.192.129</span></span></span></code></pre></div>
<p>The first block sets variables for the OpenVSwitch part. Note that we tag the itc-wan1 interface as the vlan 25. We do the same on the interface defined by libvirt in order to be able to test the virtual machine connectivity, in the vlan 25, on the ovs-wan1 bridge.
Is it working ?</p>
<p>If I check connectivity from the hypervisor, to the virtual machine (remember, dummy setup, but good to test quickly, I could have booted two virtual machines to :) ):</p>
<pre tabindex="0"><code class="language-terminal" data-lang="terminal">ping 192.168.192.130
PING 192.168.192.130 (192.168.192.130) 56(84) bytes of data.
64 bytes from 192.168.192.130: icmp_seq=1 ttl=64 time=0.308 ms
64 bytes from 192.168.192.130: icmp_seq=2 ttl=64 time=0.153 ms</code></pre>
<p>TADAA !</p>
<h2 id="flaws">Flaws</h2>
<p>There are many flaws in this setup:</p>
<ul>
<li>Using the ansible virt module to define the domain, we can&rsquo;t edit the domain later. Redefining the domain won&rsquo;t work as the module doesn&rsquo;t act if the domain is already defined. With this setup it is necessary either to edit the domain by hand, or improve this setup calling virsh directly from shell commands, getting each operations result and interpret them to keep the idempotency. The best way is probably to make a better setup based on virsh attach/detach-interface, attach/detach-device and so on&hellip; I&rsquo;ll improve that part in a next post.</li>
<li>Here I presented the basic setup which permits to deploy new bridges, interfaces and virtual machines, but the deletion is not handled properly, this is for the next step. The jinja2 templates could be improved to.
I don&rsquo;t use libvirt networks to configure ovs bridges, it would be proper to do so.
As I said in the introduction, this setup lacks a lot of features to be nice, I&rsquo;ll improve it step by step ;)</li>
</ul>
<p>Feel free to contact me or comment on any social media listed below.</p>


  <h3>Related Posts</h3>
  <ul>
    
      <li><a href="/2017/09/automate-your-virtual-machine-templates-creation-with-packer/">Automate your virtual machine templates creation with Packer</a></li>
    
      <li><a href="/2017/07/make-ansible-run-on-debian-9/">Make Ansible Run on Debian 9</a></li>
    
  </ul>

</div>
    <div class="post__footer">
      

      
        <span><a class="tag" href="/tags/automation/">automation</a><a class="tag" href="/tags/cloud/">cloud</a><a class="tag" href="/tags/ansible/">ansible</a><a class="tag" href="/tags/cloud-init/">cloud-init</a><a class="tag" href="/tags/libvirt/">libvirt</a><a class="tag" href="/tags/qemu/">qemu</a><a class="tag" href="/tags/kvm/">kvm</a><a class="tag" href="/tags/openvswitch/">openvswitch</a></span>


      
    </div>

    
  </div>

      </main>
    </div><footer class="footer footer__base">
  <ul class="footer__list">
    <li class="footer__item">
      &copy;
      
        Benoit Petit
        2025
      
    </li>
    
  </ul>
</footer>
  
  <script
    type="text/javascript"
    src="/js/medium-zoom.min.9531b4a2217a70c5a1fce89c1f81c9ebbdd586708fcd4130b417320c7230c8d6.js"
    integrity="sha256-lTG0oiF6cMWh/OicH4HJ673VhnCPzUEwtBcyDHIwyNY="
    crossorigin="anonymous"
  ></script></body>
</html>
